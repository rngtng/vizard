%header
  .inner
    %h1 UML Generator
    .sub
      Graphs generated with PlantUML - download
      %a{href:"http://sourceforge.net/projects/plantuml/files/PlantUML%20Language%20Reference%20Guide.pdf/download"} Language Guide

  %a{href:"https://github.com/soundcloud/uml-generator"}
    %img.gh-forkme{src:"//s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png", alt:"Fork me on GitHub"}

#main
  %section#demo
    %table{align:"center", width:"100%"}
      %tr
        %td{valign:'top', width:"600px"}
          .editor-wrapper
            .editor= Rack::Utils.escape(diagram)
        %td{align:'left', valign:'top'}
          %ul
            %li
              %a Download as SVG
            %li
              %a Download as Text
            - unless github_path.empty?
              %li
                %a.js-save.fancybox{href:"#new-commit"} Save to GitHub

          .diagram
            %a.fancybox{href:"#"}
              %img{src:"#", border:1}

#new-commit.new-commit
  .bubble
    .bubble-contents
      .merge-message
        %form{action:"/update?#{github_path}", method:"POST"}
          %label.commit-message-summary-label{for:"commit-summary-input"} Commit summary:
          %input#commit-summary-input.commit-message-summary{type:"text", placeholder:"Update #{File.basename(github_path)}", name:"message"}
          %input{type:"hidden", name:"placeholder_message", value:"Update #{File.basename(github_path)}"}
          %input{type:"hidden", name:"content"}

          %label.commit-message-label{for:"commit-description-textarea"}
            Extended description: <small>(optional)</small>
          %textarea#commit-description-textarea.commit-message{name:"description"}

          .author
            %img{height:"30", src:user[:avatar_url], width:"30"}
            %strong.author-name
              %a{href:user[:url]}= user[:login]
            %span.author-email= user[:email]

          .merge-branch-form-actions
            %button#submit-file.button.primary.js-blob-submit{type:"submit"}
              Commit Changes

%script{src:"/javascript/ace/ace.js"}
%script{src:"/javascript/fancybox/jquery.fancybox.pack.js?v=2.1.5"}

:javascript
  function setup_editor(div) {
    var editor_div = div.find(".editor"),
    diagram_div = div.find(".diagram"),
    on_change = function() {
      $('input[name="content"]').val(editor.getSession().getValue());
      $.ajax( {
        url: '/render.png',
        type: 'post',
        data: editor.getSession().getValue(),
        headers: {
            'Accept': 'image/png;base64'
        },
        success: function( data ) {
          diagram_div.find('a').attr('href', 'data:image/png;base64,' + data);
          diagram_div.find('img').attr('src', 'data:image/png;base64,' + data);
        }
      });
    },
    urldecode = function (url) {
      return decodeURIComponent(url.replace(/\+/g, ' '));
    },
    editor = ace.edit(editor_div.get(0)),
    defaultValue = editor.getSession().getValue();


    editor.getSession().setValue(urldecode(defaultValue));
    editor.setFontSize(10);
    editor.setTheme("ace/theme/github");
    editor.commands.addCommand({
      name: 'save',
      bindKey: {win: 'Ctrl-S',  mac: 'Command-S'},
      exec: function(editor) {
        $('a.js-save').click();
      }
    })

    editor.getSession().setMode('ace/mode/diagram');
    editor.getSession().on('change', on_change);
    on_change();
  }

  $(document).ready(function() {
    $(".fancybox").fancybox();
    setup_editor($('#demo'));
  });
